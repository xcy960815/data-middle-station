# 高频调度任务使用说明

## 功能概述

调度系统现已支持高频执行模式，可以实现"每N分钟执行一次"的任务。

## 使用方法

### 1. 时间格式

调度系统支持两种时间格式：

#### 标准时间格式（固定时间点）

- **格式**: `HH:mm:ss`
- **示例**: `09:30:00` 表示每天早上9点30分执行
- **用途**: 每天固定时间执行的任务

#### 高频执行格式（间隔执行）

- **格式**: `*/N`
- **示例**:
  - `*/1` 表示每1分钟执行一次
  - `*/2` 表示每2分钟执行一次
  - `*/5` 表示每5分钟执行一次
  - `*/10` 表示每10分钟执行一次
- **用途**: 高频监控、测试任务等

### 2. SQL 示例

```sql
-- 每1分钟执行一次
INSERT INTO `scheduled_email_tasks` (
  `task_name`,
  `task_type`,
  `recurring_days`,
  `recurring_time`,
  `is_active`,
  ...
) VALUES (
  '测试任务 - 每1分钟',
  'recurring',
  '[0,1,2,3,4,5,6]',  -- 每天都执行
  '*/1',               -- 每1分钟
  1,
  ...
);

-- 每天早上9点执行
INSERT INTO `scheduled_email_tasks` (
  `task_name`,
  `task_type`,
  `recurring_days`,
  `recurring_time`,
  `is_active`,
  ...
) VALUES (
  '日报任务',
  'recurring',
  '[0,1,2,3,4,5,6]',  -- 每天都执行
  '09:00:00',          -- 早上9点
  1,
  ...
);
```

### 3. Cron 表达式转换

系统会自动将时间格式转换为 cron 表达式：

| 输入格式   | Cron 表达式                 | 说明         |
| ---------- | --------------------------- | ------------ |
| `*/1`      | `0 */1 * * * 0,1,2,3,4,5,6` | 每1分钟执行  |
| `*/5`      | `0 */5 * * * 0,1,2,3,4,5,6` | 每5分钟执行  |
| `09:30:00` | `0 30 9 * * 0,1,2,3,4,5,6`  | 每天9:30执行 |

## 测试脚本

已提供测试脚本：`sql/insert_test_task_1min.sql`

包含以下测试任务：

- 每1分钟执行一次
- 每2分钟执行一次
- 每5分钟执行一次

## 注意事项

1. **高频任务慎用**：每1分钟的任务会产生大量执行记录，仅用于测试
2. **生产环境建议**：生产环境建议最小间隔为5分钟
3. **资源消耗**：高频任务会增加数据库和邮件服务器的负载
4. **测试完成后记得删除**：测试任务完成后应及时删除或禁用

## 删除测试任务

```sql
-- 删除所有测试任务
DELETE FROM `scheduled_email_tasks` WHERE task_name LIKE '%测试任务%';

-- 或者禁用测试任务
UPDATE `scheduled_email_tasks`
SET is_active = 0
WHERE task_name LIKE '%测试任务%';
```

## 技术实现

- 使用 `node-schedule` 库
- 支持标准 cron 表达式
- 自动检测时间格式并转换
- 详细的日志输出

## 日志示例

```
🔧 构建高频 cron 表达式: 0 */1 * * * 0,1,2,3,4,5,6 (每1分钟执行)
🔄 重复任务已注册: 23 - 测试任务 - 每1分钟, 执行周期: 周日、周一、周二、周三、周四、周五、周六 */1, 下次执行: 2025/11/11 23:48:00
🚀 执行重复任务: 23 - 测试任务 - 每1分钟
✅ 任务 23 执行成功
```
